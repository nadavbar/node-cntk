<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width" />

  <title>NodeJs CNTK Example</title>

  <script type="text/javascript" src="./lib/jquery.1.10.2.min.js"></script>
</head>

<body>

  <!-- jQuery UI -->
  <script type="text/javascript" src="./lib/jquery.ui.core.1.10.3.min.js"></script>
  <script type="text/javascript" src="./lib/jquery.ui.widget.1.10.3.min.js"></script>
  <script type="text/javascript" src="./lib/jquery.ui.mouse.1.10.3.min.js"></script>
  <script type="text/javascript" src="./lib/jquery.ui.draggable.1.10.3.min.js"></script>

  <!-- wPaint -->
  <script type="text/javascript" src="./src/wPaint.utils.js"></script>
  <script type="text/javascript" src="./src/wPaint.js"></script>

  <!-- wPaint main -->
  <script type="text/javascript" src="./plugins/main/src/wPaint.menu.main.js"></script>

  <!-- wPaint file -->

  <div id="wPaint-demo1" style="position:relative; border-style: solid;border-width:1px ; width:300px; height:300px; background-color:white; margin:70px auto 20px auto;"></div>

  </center>
  <img id="img" src="" />
  <div id="buttons" style="position:relative;text-align: center">
    <input type="button" value="Go!" onclick="getpixelarray();" style="position: relative; " />
    <input type="button" value="Clear" onclick="clear1();" style="position: relative; " />
  </div>
  <div id="Result" style="position:relative;text-align: center">
    <br> Drawn number is:
    <input type="text" id="result" />
  </div>

  <center id="wPaint-img"></center>

  <script type="text/javascript">
    function convertBase64ToPixelsArray(base64DataUrl) {
      var mCanvas = (document.createElement('canvas'));

      var ctx = mCanvas.getContext("2d");
      var pixelsArray = [];
      var img = document.getElementById('img');
      var im = new Image();
      im.src = base64DataUrl
      im.onload =
        function getRGB() {
          var scaleWidthRatio = 28 / this.width;
          var scaleHeightRatio = 28 / this.height;

          ctx.drawImage(this, 0, 0, this.width, this.height, 0, 0, 28, 28);
          var data = ctx.getImageData(0, 0, 28, 28).data


          for (var i = 0; i < data.length; i += 4) {
            //var grey = (data[i]+data[i+1]+data[i+2])/3;
            color = data[i + 3] > 0 ? 255 : 0;
            pixelsArray.push(color);
          }

          $.ajax({
            url: '/recognize/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ payload: pixelsArray }),
            success: function (resp) {
              var r = document.getElementById('result');
              r.value = JSON.parse(resp).digit
            }
          });
        }
    }

    function clear1() {
      $("#wPaint-demo1").wPaint("clear");
    }

    function getpixelarray() {
      var imageData = $("#wPaint-demo1").wPaint("image");

      convertBase64ToPixelsArray(imageData);
    }
  </script>

  <script type="text/javascript">
      // init wPaint
      $('#wPaint-demo1').wPaint({
      });
  </script>

</body>

</html>